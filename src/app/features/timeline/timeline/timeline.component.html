<div class="timeline-container">
  <!-- Header -->
  <header class="timeline-header">
    <h1>Work Order Schedule</h1>
    <div class="controls">
      <!-- Search Box -->
      <div class="search-box">
        <input type="text" placeholder="Search resources..." (input)="onSearch($event)">
      </div>
      <label>Timescale:</label>
      <select [value]="viewMode()" (change)="setViewMode($any($event.target).value)">
        <option value="Day">Day</option>
        <option value="Week">Week</option>
        <option value="Month">Month</option>
      </select>
    </div>
  </header>

  <div class="timeline-body">
    <!-- Left Panel: Work Centers -->
    <div class="sidebar">
      <div class="sidebar-header">Work Center</div>
      <div class="sidebar-content">
        @for (wc of filteredWorkCenters(); track wc.docId; let i = $index) {
          <!-- Show Group Header if it's the first item OR different from previous -->
          @if (i === 0 || getGroup(wc) !== getGroup(filteredWorkCenters()[i-1])) {
            <div class="group-header">{{ getGroup(wc) }}</div>
          }
          <div class="sidebar-row">{{ wc.data.name }}</div>
        }
      </div>
    </div>

    <!-- Right Panel: Grid -->
    <div class="grid-viewport">
      <div class="grid-header">
        @for (date of visibleDates(); track date) {
          <div class="date-cell">
            {{ date | date: (viewMode() === 'Month' ? 'MMM yyyy' : 'dd MMM') }}
          </div>
        }
      </div>

      <div class="grid-content">
        @for (wc of filteredWorkCenters(); track wc.docId; let i = $index) 
        {
          @if (i === 0 || getGroup(wc) !== getGroup(filteredWorkCenters()[i-1])) {
             <div class="group-header-spacer"></div>
          }
          <div class="grid-row" (click)="onCreateOrder(wc.docId)">
            
            <div class="grid-lines-layer">
              @for (date of visibleDates(); track date) {
                 <div class="grid-cell"></div>
              }
            </div>

            <div class="bars-layer">
              @for (order of workOrders(); track order.docId) {
                @if (order.data.workCenterId === wc.docId) {
                  <div 
                    class="work-order-bar" 
                    [ngClass]="{
                      'conflict': conflictingOrderIds().has(order.docId),
                      'open': order.data.status === 'open',
                      'in-progress': order.data.status === 'in-progress',
                      'complete': order.data.status === 'complete',
                      'blocked': order.data.status === 'blocked'
                    }"
                    [ngStyle]="getOrderStyles(order)"
                    (click)="onEditOrder(order, $event)"
                  >
                    <span class="order-name">{{ order.data.name }}</span>
                    <button class="action-btn">â‹®</button>
                  </div>
                }
              }
            </div>

          </div>
        }
      </div>
    </div>
  </div>

  <!-- 3. ADD THE MODAL COMPONENT HERE -->
  @if (isModalOpen() && selectedOrder()) {
    <app-order-modal 
      [order]="selectedOrder()!"
      (closeEvent)="closeModal()"
      (saveEvent)="onSaveOrder($event)"
      (deleteEvent)="onDeleteOrder($event)"
    ></app-order-modal>
  }
</div>
